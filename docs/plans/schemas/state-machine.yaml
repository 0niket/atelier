# Harness State Machine Schema
# Enforced by plugin - users cannot modify schema
# State file: tmp/<timestamp>-<task-file-name>.json

type: object
required:
  - version
  - feature
  - stateFile
  - currentTask
  - workflow
  - coherence
properties:
  version:
    type: string
    description: Schema version
    const: "1.0.0"

  feature:
    type: object
    required: [id, name, branch]
    properties:
      id:
        type: string
        pattern: "^\\d{3}-[a-z0-9-]+$"
        description: Feature ID (e.g., "001-shopping-cart")
      name:
        type: string
        description: Human-readable feature name
      branch:
        type: string
        description: Git branch name

  stateFile:
    type: object
    required: [path, createdAt, lastUpdated]
    properties:
      path:
        type: string
        description: Full path to this state file
      createdAt:
        type: string
        format: date-time
      lastUpdated:
        type: string
        format: date-time

  currentTask:
    type: object
    required: [id, status, phase]
    properties:
      id:
        type: string
        pattern: "^T\\d{3}$"
        description: Current task ID (e.g., "T007")
      status:
        type: string
        enum: [preparing, red, green, refactor, verifying, done]
        description: Current TDD phase or task status
      phase:
        type: string
        enum: [foundation, user-story, polish, qa]
        description: Which workflow phase
      nextTaskId:
        type: string
        pattern: "^T\\d{3}$|^null$"
        description: Next task to execute (linked list)

  workflow:
    type: object
    required: [spec, plan, tasks]
    properties:
      spec:
        type: object
        required: [path, exists]
        properties:
          path: { type: string }
          exists: { type: boolean }
      plan:
        type: object
        required: [path, exists]
        properties:
          path: { type: string }
          exists: { type: boolean }
      tasks:
        type: object
        required: [path, exists, totalTasks, completedTasks]
        properties:
          path: { type: string }
          exists: { type: boolean }
          totalTasks: { type: integer, minimum: 0 }
          completedTasks: { type: integer, minimum: 0 }

  coherence:
    type: object
    required: [specPlanAlignment, planTasksAlignment, lastCheck]
    properties:
      specPlanAlignment:
        type: boolean
        description: Spec and plan coherent
      planTasksAlignment:
        type: boolean
        description: Plan and tasks coherent
      planImplementationAlignment:
        type: boolean
        description: Plan and actual code coherent
      violations:
        type: array
        items:
          type: object
          required: [type, description, severity]
          properties:
            type:
              type: string
              enum: [spec-plan, plan-tasks, plan-implementation, unplanned-code]
            description: { type: string }
            severity:
              type: string
              enum: [blocker, warning]
      lastCheck:
        type: string
        format: date-time

  tasks:
    type: object
    description: Task execution tracking (linked list)
    patternProperties:
      "^T\\d{3}$":
        type: object
        required: [id, description, status, userStory, nextTask]
        properties:
          id: { type: string, pattern: "^T\\d{3}$" }
          description: { type: string }
          status:
            type: string
            enum: [pending, in-progress, done, blocked]
          userStory:
            type: string
            pattern: "^US-\\d+$|^foundation$|^polish$"
            description: Which user story this belongs to
          tddPhase:
            type: string
            enum: [red, green, refactor, complete]
            description: TDD cycle tracking
          specReference:
            type: array
            items: { type: string }
            description: Acceptance criteria this covers
          domainElements:
            type: array
            items: { type: string }
            description: Aggregates/entities involved
          filePath: { type: string }
          nextTask:
            type: string
            pattern: "^T\\d{3}$|^null$"
            description: Next task in linked list
          previousTask:
            type: string
            pattern: "^T\\d{3}$|^null$"
          dependencies:
            type: array
            items: { type: string }
            description: Tasks that must complete first
          parallel:
            type: boolean
            description: Can run parallel with siblings
          completedAt:
            type: string
            format: date-time
